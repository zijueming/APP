<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鏂囩尞绠＄悊骞冲彴</title>
    <!-- 寮曞叆Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 浣跨敤 'Inter' 瀛椾綋 (Tailwind 榛樿) */
        body {
            font-family: 'Inter', 'sans-serif';
            overflow: hidden; /* 闃叉椤甸潰婊氬姩 */
        }
        /* 璇︽儏椤垫爣绛炬縺娲绘牱寮?*/
        .tab-active {
            border-bottom-color: #3b82f6; /* blue-600 */
            color: #3b82f6;
            font-weight: 500;
        }
        /* 鍔犺浇鍔ㄧ敾 */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen">
        <!-- 渚ц竟鏍?-->
        <aside class="w-60 bg-white shadow-md flex flex-col flex-shrink-0">
            <!-- Logo -->
            <div class="h-16 flex items-center justify-center border-b">
                <h1 class="text-xl font-bold text-blue-600">FuckPaper</h1>
            </div>
            
            <!-- 瀵艰埅鑿滃崟 -->
            <nav class="flex-1 mt-4">
                <a href="#" class="flex items-center px-6 py-3 text-blue-600 bg-blue-50 border-r-4 border-blue-600">
                    <!-- icon: 鏂囩尞鍒楄〃 -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    <span>鏂囩尞鍒楄〃</span>
                </a>
            </nav>

            <!-- 缁熻淇℃伅 -->
            <div class="p-4 m-4 border rounded-lg bg-gray-50">
                <h3 class="font-semibold text-sm mb-4">缁熻淇℃伅</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>鎬绘枃鐚暟</span>
                        <span id="stat-total" class="font-medium">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>鏈湀鏂板</span>
                        <span id="stat-new" class="font-medium text-green-600">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>鎬绘爣绛炬暟</span>
                        <span id="stat-tags" class="font-medium text-blue-600">0</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 涓诲唴瀹瑰尯 -->
        <div class="flex-1 flex flex-col">
            <!-- 椤堕儴鏍?-->
            <header class="h-16 bg-white border-b flex items-center justify-between px-6 flex-shrink-0">
                <!-- 鎼滅储妗?-->
                <div class="relative">
                    <input type="text" placeholder="鍏ㄥ眬鎼滅储鏂囩尞..." class="pl-10 pr-4 py-2 w-80 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <!-- icon: 鎼滅储 -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                
                <!-- 鍙充晶鍥炬爣鍜岀敤鎴?-->
                <div class="flex items-center space-x-4">
                    <!-- 閰嶇疆API鎸夐挳 -->
                    <button id="openApiModalBtn" class="flex items-center text-sm text-gray-600 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        閰嶇疆API
                    </button>
                    <!-- 鐢ㄦ埛澶村儚 -->
                    <div class="flex items-center space-x-2">
                        <span class="h-8 w-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold">鐖卞洜鏂潶</span>
                    </div>
                </div>
            </header>

            <!-- ************************** -->
            <!-- * 鏂囩尞鍒楄〃瑙嗗浘     * -->
            <!-- ************************** -->
            <main id="listView" class="flex-1 p-6 overflow-auto">
                <!-- 闈㈠寘灞?-->
                <div class="text-sm text-gray-500 mb-4">
                    <span>棣栭〉</span> &gt; <span>鏂囩尞鍒楄〃</span>
                </div>
                
                <!-- 鏍囬鍜屾搷浣滄寜閽?-->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">鎴戠殑鏂囩尞</h2>
                    <div class="space-x-2">
                        <!-- 闅愯棌鐨?file input -->
                        <input type="file" id="pdfUploadInput" class="hidden" accept=".pdf">
                        
                        <button id="importButton" class="flex items-center bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            瀵煎叆鏂囩尞
                        </button>
                        <button class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            鎵归噺瀵煎嚭
                        </button>
                    </div>
                </div>

                <!-- 杩囨护鍣ㄥ拰琛ㄦ牸 -->
                <div class="bg-white rounded-lg shadow-lg">
                    <!-- 杩囨护鍣?-->
                    <div class="p-4 border-b flex items-center justify-between space-x-4">
                        <input type="text" placeholder="鎼滅储鏂囩尞鏍囬銆佷綔鑰呫€佸叧閿瘝..." class="flex-1 border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select class="border rounded-lg px-4 py-2 text-sm focus:outline-none">
                            <option>鍏ㄩ儴骞翠唤</option>
                        </select>
                        <select id="tagFilterDropdown" class="border rounded-lg px-4 py-2 text-sm focus:outline-none">
                            <option>鍏ㄩ儴鏍囩</option>
                            <!-- 鏍囩灏嗗姩鎬佸～鍏?-->
                        </select>
                        <button id="openGlobalTagModalBtn" class="text-sm text-blue-600 hover:underline whitespace-nowrap">绠＄悊鍏ㄩ儴鏍囩</button>
                    </div>
                    
                    <!-- 琛ㄦ牸 -->
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="p-4 w-12"><input type="checkbox"></th>
                                <th class="p-4">鏍囬</th>
                                <th class="p-4 w-40">浣滆€?/th>
                                <th class="p-4 w-24">骞翠唤</th>
                                <th class="p-4 w-48">鑷畾涔夋爣绛?/th>
                                <th class="p-4 w-32">鎿嶄綔</th>
                            </tr>
                        </thead>
                        <!-- [鏂癩 鍔ㄦ€佽〃鏍间富浣?-->
                        <tbody id="literatureTableBody">
                            <!-- 绀轰緥: 鏃犳暟鎹椂 -->
                             <tr id="noDataRow">
                                <td colspan="6" class="p-8 text-center text-gray-500">
                                    鏆傛棤鏂囩尞銆傝鐐瑰嚮 "瀵煎叆鏂囩尞" 寮€濮嬨€?                                </td>
                            </tr>
                            <!-- 鍔ㄦ€佸唴瀹瑰皢鎻掑叆姝ゅ -->
                        </tbody>
                    </table>

                    <!-- 鍒嗛〉 -->
                    <div class="p-4 flex justify-between items-center text-sm">
                        <div>
                            <span id="paginationInfo">鏄剧ず 0 鏉? 鍏?0 鏉¤褰?/span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <!-- 鍒嗛〉鍔熻兘鏆傛湭瀹炵幇 -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- ************************** -->
            <!-- * 鏂囩尞璇︽儏瑙嗗浘     * -->
            <!-- ************************** -->
            <main id="detailView" class="flex-1 p-6 overflow-auto hidden bg-white">
                <!-- 椤堕儴鎿嶄綔鏍?-->
                <div class="flex justify-between items-center mb-4">
                    <div class="text-sm text-gray-500">
                        <button id="backToListBtn" class="text-blue-600 hover:underline">&lt; 杩斿洖鏂囩尞鍒楄〃</button>
                    </div>
                    <div class="space-x-2 flex flex-wrap gap-2">
                        <button id="manageImagesBtn" class="flex-shrink-0 bg-blue-50 border border-blue-200 text-blue-700 px-3 py-1.5 rounded-lg text-sm hover:bg-blue-100">绠＄悊鍥剧墖</button>
                        <button id="detailEditTagsBtn" class="flex-shrink-0 bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">缂栬緫鏍囩</button>
                        <button class="flex-shrink-0 bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">瀵煎嚭</button>
                        <button id="detailDeleteBtn" class="flex-shrink-0 bg-red-50 border border-red-200 text-red-600 px-3 py-1.5 rounded-lg text-sm hover:bg-red-100">鍒犻櫎</button>
                    </div>
                </div>

                <!-- 鏂囩尞淇℃伅 (鏉ヨ嚜JSON) -->
                <div id="lit-info" class="mb-6">
                    <h2 id="lit-title" class="text-2xl font-semibold mb-2"></h2>
                    <p id="lit-authors" class="text-sm text-gray-600 mb-1"></p>
                    <p class="text-sm text-gray-500">
                        <span id="lit-journal"></span>, <span id="lit-year"></span>
                    </p>
                </div>

                <!-- [淇敼] 绉婚櫎 Tab 瀵艰埅 -->
                <!-- <div class="border-b border-gray-200 mb-6"> ... </div> -->

                <!-- [淇敼] Tab 鍐呭 (鏀逛负鍗曢〉婊氬姩) -->
                <div id="detailTabContent" class="max-w-4xl mx-auto space-y-10">
                    <!-- 1. 鏂囩尞姒傝 -->
                    <div id="tab-overview" class="tab-content space-y-4">
                        <h3 class="text-xl font-semibold border-b pb-2">鎽樿</h3>
                        <p id="lit-abstract" class="text-gray-700 leading-relaxed"></p>
                    </div>

                    <!-- 2. 鍥捐〃瑙ｆ瀽 -->
                    <div id="tab-figures" class="tab-content space-y-4">
                        <h3 class="text-xl font-semibold border-b pb-2">鍏抽敭鍥捐〃</h3>
                        <div id="lit-figures-list" class="space-y-6">
                            <!-- 鍥捐〃椤瑰皢鍦ㄨ繖閲屽姩鎬佺敓鎴?-->
                        </div>
                    </div>

                    <!-- 3. 缁撹涓庡垱鏂扮偣 -->
                    <div id="tab-conclusion" class="tab-content space-y-4">
                        <h3 class="text-xl font-semibold border-b pb-2">涓昏缁撹</h3>
                        <div id="lit-conclusions" class="text-gray-700"></div>

                        <h3 class="text-xl font-semibold border-b pb-2 mt-6">鍒涙柊鐐?/h3>
                        <div id="lit-innovations" class="text-gray-700"></div>
                    </div>

                    <!-- 4. 涓嶈冻涓庡睍鏈?-->
                    <div id="tab-todos" class="tab-content space-y-4">
                        <h3 class="text-xl font-semibold border-b pb-2">涓嶈冻</h3>
                        <div id="lit-shortcomings" class="text-gray-700"></div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- ************************** -->
    <!-- * 妯℃€佸脊绐?      * -->
    <!-- ************************** -->

    <!-- 1. 閰嶇疆API 妯℃€佺獥 -->
    <div id="apiModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">閰嶇疆 API</h3>
                <button id="closeApiModalBtn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div>
                <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-2">DeepSeek API 瀵嗛挜</label>
                <input type="password" id="apiKey" name="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="璇疯緭鍏ユ偍鐨凙PI瀵嗛挜">
            </div>
            <div class="mt-6 flex justify-end">
                <button id="saveApiKeyBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">淇濆瓨</button>
            </div>
        </div>
    </div>

    <!-- [鏂癩 2. 绠＄悊鏍囩 妯℃€佺獥 (閲嶆柊娣诲姞) -->
    <div id="tagModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="tagModalTitle" class="text-lg font-semibold">绠＄悊鑷畾涔夋爣绛?/h3>
                <button id="closeTagModalBtn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <!-- [鏂癩 娣诲姞鏂版爣绛?(鍙殣钘? -->
            <div id="addNewTagSection" class="flex space-x-2 mb-4">
                <input type="text" id="newTagName" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="杈撳叆鏂版爣绛惧悕绉?>
                <button id="addNewTagBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">娣诲姞</button>
            </div>
            <!-- 鐜版湁鏍囩鍒楄〃 -->
            <div class="space-y-2 max-h-60 overflow-auto" id="existingTagsList">
                <!-- 鏍囩鍒楄〃灏嗗姩鎬佸～鍏?-->
            </div>
        </div>
    </div>

    <!-- [鏂癩 3. 鍔犺浇涓?瑕嗙洊灞?(涔嬪墠瀛樺湪锛屼繚鎸? -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex-col flex items-center justify-center hidden z-[100]">
        <img src="/assets/zhanshi.jpg" alt="鍒嗘瀽灞曠ず鍥? class="max-w-xs w-full mb-4 rounded-xl shadow-2xl border-4 border-white/30" loading="lazy">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <h2 class="text-xl font-semibold text-white">姝ｅ湪鍒嗘瀽涓?..</h2>
        <p class="text-white">杩欏彲鑳介渶瑕?-2鍒嗛挓锛岃鍕垮叧闂〉闈€?/p>
    </div>
    
    <!-- [鏂癩 4. 鑷畾涔夌‘璁ゆ 妯℃€佺獥 (閲嶆柊娣诲姞) -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-[101]">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 id="confirmTitle" class="text-lg font-semibold mb-4">纭鎿嶄綔</h3>
            <p id="confirmMessage" class="text-gray-700 mb-6">鎮ㄧ‘瀹氳鎵ц姝ゆ搷浣滃悧锛?/p>
            <div class="flex justify-end space-x-2">
                <button id="confirmCancelBtn" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-50">
                    鍙栨秷
                </button>
                <button id="confirmOkBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">
                    纭鍒犻櫎
                </button>
            </div>
        </div>
    </div>

    <!-- 4. 鍥剧墖绠＄悊 妯℃€佺獥 -->
    <div id="imageManagerModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center hidden z-[103]">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-6 relative">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-lg font-semibold">绠＄悊鍥剧墖鏍囨敞</h3>
                    <p class="text-sm text-gray-500">鎸夌収鍒楄〃椤哄簭鑷姩缂栧彿锛涙爣璁颁负鈥滃瓙鍥锯€濅細缁ф壙涓婁竴寮犲浘鍙凤紝灏侀潰/蹇界暐涓嶄細鍙備笌缂栧彿銆?/p>
                </div>
                <button id="closeImageManagerBtn" class="text-2xl leading-none text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="imageMetadataError" class="text-sm text-red-500 mb-3 hidden"></div>
            <div id="imageMetadataContainer" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- 鍥剧墖鍏冩暟鎹〃鍗?-->
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50" onclick="hideImageManagerModal()">鍙栨秷</button>
                <button id="saveImageMetadataBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">淇濆瓨璁剧疆</button>
            </div>
        </div>
    </div>
    
    <!-- 5. 鍥剧墖鏌ョ湅 妯℃€佺獥 -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-[102]" onclick="closeModal(this)">
        <img id="imageModalContent" src="" alt="鏂囩尞鍥剧墖" class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-xl">
    </div>

    <!-- 涓诲簲鐢↗avaScript -->
    <script>
        // 鍏ㄥ眬鍙橀噺
        let apiKey = localStorage.getItem('deepseek_api_key') || '';
        let currentPaperId = null;
        let imageMetadata = [];
        let currentFigureData = [];

        // DOM 鍏冪礌
        const importButton = document.getElementById('importButton');
        const pdfUploadInput = document.getElementById('pdfUploadInput');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const apiModal = document.getElementById('apiModal');
        const openApiModalBtn = document.getElementById('openApiModalBtn');
        const closeApiModalBtn = document.getElementById('closeApiModalBtn');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const apiKeyInput = document.getElementById('apiKey');
        const manageImagesBtn = document.getElementById('manageImagesBtn');
        const imageManagerModal = document.getElementById('imageManagerModal');
        const closeImageManagerBtn = document.getElementById('closeImageManagerBtn');
        const saveImageMetadataBtn = document.getElementById('saveImageMetadataBtn');
        const imageMetadataContainer = document.getElementById('imageMetadataContainer');
        const imageMetadataError = document.getElementById('imageMetadataError');

        // 鍒濆鍖?        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadLiteratureList();
            
            // 娣诲姞杩斿洖鍒楄〃鎸夐挳浜嬩欢鐩戝惉
            document.getElementById('backToListBtn').addEventListener('click', function() {
                document.getElementById('detailView').classList.add('hidden');
                document.getElementById('listView').classList.remove('hidden');
            });
        });

        // 浜嬩欢鐩戝惉鍣ㄥ垵濮嬪寲
        function initializeEventListeners() {
            // 瀵煎叆鏂囩尞鎸夐挳
            importButton.addEventListener('click', function() {
                if (!apiKey) {
                    showApiModal();
                    return;
                }
                pdfUploadInput.click();
            });

            // 鏂囦欢涓婁紶澶勭悊
            pdfUploadInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadAndAnalyzePDF(e.target.files[0]);
                }
            });

            // API 閰嶇疆妯℃€佺獥
            openApiModalBtn.addEventListener('click', showApiModal);
            closeApiModalBtn.addEventListener('click', hideApiModal);
            saveApiKeyBtn.addEventListener('click', saveApiKey);

            // 鍥剧墖绠＄悊妯℃€佺獥
            if (manageImagesBtn) {
                manageImagesBtn.addEventListener('click', openImageManagerModal);
            }
            if (closeImageManagerBtn) {
                closeImageManagerBtn.addEventListener('click', hideImageManagerModal);
            }
            if (saveImageMetadataBtn) {
                saveImageMetadataBtn.addEventListener('click', saveImageMetadata);
            }

            // 璁剧疆淇濆瓨鐨凙PI瀵嗛挜
            if (apiKey) {
                apiKeyInput.value = apiKey;
            }
        }

        // 涓婁紶鍜屽垎鏋怭DF鏂囦欢
        async function uploadAndAnalyzePDF(file) {
            if (!file || !file.name.endsWith('.pdf')) {
                alert('璇烽€夋嫨鏈夋晥鐨凱DF鏂囦欢');
                return;
            }

            if (!apiKey) {
                alert('璇峰厛閰嶇疆API瀵嗛挜');
                showApiModal();
                return;
            }

            // 鏄剧ず鍔犺浇鐘舵€?            loadingOverlay.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert('鏂囩尞瀵煎叆鎴愬姛锛?);
                    await loadLiteratureList();
                    await refreshCurrentPaperDetail();
                } else {
                    // 涓婁紶澶辫触锛屾樉绀洪敊璇俊鎭?                    alert(`瀵煎叆澶辫触: ${result.error || '鏈煡閿欒'}`);
                }
            } catch (error) {
                console.error('涓婁紶澶辫触:', error);
                alert('涓婁紶澶辫触锛岃妫€鏌ョ綉缁滆繛鎺?);
            } finally {
                // 闅愯棌鍔犺浇鐘舵€?                loadingOverlay.classList.add('hidden');
                // 閲嶇疆鏂囦欢杈撳叆
                pdfUploadInput.value = '';
            }
        }

        // API 瀵嗛挜绠＄悊
        function showApiModal() {
            apiModal.classList.remove('hidden');
        }

        function hideApiModal() {
            apiModal.classList.add('hidden');
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (!key) {
                alert('璇疯緭鍏PI瀵嗛挜');
                return;
            }
            apiKey = key;
            localStorage.setItem('deepseek_api_key', key);
            alert('API瀵嗛挜宸蹭繚瀛?);
            hideApiModal();
        }

        // 鍔犺浇鏂囩尞鍒楄〃
        async function loadLiteratureList() {
            try {
                const response = await fetch('/api/literature');
                const literatureList = await response.json();
                
                if (response.ok) {
                    renderLiteratureTable(literatureList);
                    updateStatistics(literatureList);
                } else {
                    console.error('鍔犺浇鏂囩尞鍒楄〃澶辫触:', literatureList.error);
                }
            } catch (error) {
                console.error('鍔犺浇鏂囩尞鍒楄〃澶辫触:', error);
            }
        }

        // 娓叉煋鏂囩尞琛ㄦ牸
        function renderLiteratureTable(literatureList) {
            const tableBody = document.getElementById('literatureTableBody');
            const noDataRow = document.getElementById('noDataRow');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // 鏇存柊鍒嗛〉淇℃伅
            paginationInfo.textContent = `鏄剧ず ${literatureList.length} 鏉? 鍏?${literatureList.length} 鏉¤褰昤;
            
            if (literatureList.length === 0) {
                noDataRow.classList.remove('hidden');
                tableBody.innerHTML = '';
                tableBody.appendChild(noDataRow);
                return;
            }

            noDataRow.classList.add('hidden');
            
            tableBody.innerHTML = literatureList.map(item => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4"><input type="checkbox"></td>
                    <td class="p-4">
                        <div class="font-medium">${escapeHtml(item.title || '鏃犳爣棰?)}</div>
                    </td>
                    <td class="p-4">${escapeHtml((item.authors || []).join(', ') || '鏈煡浣滆€?)}</td>
                    <td class="p-4">${escapeHtml(item.year || '鏈煡骞翠唤')}</td>
                    <td class="p-4">
                        <div class="flex flex-wrap gap-1">
                            ${(item.custom_tags || []).map(tag => 
                                `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${escapeHtml(tag)}</span>`
                            ).join('')}
                        </div>
                    </td>
                    <td class="p-4">
                        <button class="text-blue-600 hover:underline text-sm" onclick="viewLiteratureDetail('${item.id}')">鏌ョ湅</button>
                        <button class="text-red-600 hover:underline text-sm ml-2" onclick="deleteLiterature('${item.id}')">鍒犻櫎</button>
                    </td>
                </tr>
            `).join('');
        }

        // 鏇存柊缁熻淇℃伅
        function updateStatistics(literatureList) {
            document.getElementById('stat-total').textContent = literatureList.length;
            document.getElementById('stat-new').textContent = literatureList.length; // 绠€鍖栵細鍏ㄩ儴绠椾綔鏂板
            document.getElementById('stat-tags').textContent = new Set(
                literatureList.flatMap(item => item.custom_tags || [])
            ).size;
        }

        // 鏌ョ湅鏂囩尞璇︽儏
        async function viewLiteratureDetail(paperId) {
            try {
                // 鏄剧ず鍔犺浇鐘舵€?                loadingOverlay.classList.remove('hidden');
                
                const response = await fetch(`/api/literature/${paperId}`);
                const literatureData = await response.json();
                
                if (response.ok) {
                    // 鍒囨崲鍒拌鎯呰鍥?                    document.getElementById('listView').classList.add('hidden');
                    document.getElementById('detailView').classList.remove('hidden');
                    
                    // 鍏堣缃綋鍓嶆枃鐚甀D锛屽啀濉厖鏁版嵁
                    currentPaperId = paperId;
                    
                    // 濉厖鏂囩尞璇︽儏鏁版嵁
                    fillLiteratureDetail(literatureData);
                    await loadImageMetadata(paperId);
                } else {
                    alert(`鍔犺浇鏂囩尞璇︽儏澶辫触: ${literatureData.error || '鏈煡閿欒'}`);
                }
            } catch (error) {
                console.error('鏌ョ湅鏂囩尞璇︽儏澶辫触:', error);
                alert('鍔犺浇鏂囩尞璇︽儏澶辫触锛岃妫€鏌ョ綉缁滆繛鎺?);
            } finally {
                // 闅愯棌鍔犺浇鐘舵€?                loadingOverlay.classList.add('hidden');
            }
        }

        // 濉厖鏂囩尞璇︽儏鏁版嵁
        function fillLiteratureDetail(data) {
            // 鍩烘湰淇℃伅
            document.getElementById('lit-title').textContent = data.鏂囩尞淇℃伅?.鏍囬 || '鏃犳爣棰?;
            document.getElementById('lit-authors').textContent = data.鏂囩尞淇℃伅?.浣滆€?.join(', ') || '鏈煡浣滆€?;
            document.getElementById('lit-journal').textContent = data.鏂囩尞淇℃伅?.鏈熷垔 || '鏈煡鏈熷垔';
            document.getElementById('lit-year').textContent = data.鏂囩尞淇℃伅?.骞翠唤 || '鏈煡骞翠唤';
            
            // 鎽樿 - 淇璺緞
            document.getElementById('lit-abstract').textContent = data.鍐呭鎻愬彇?.鎽樿 || '鏃犳憳瑕?;
            
            // 缁撹涓庡垱鏂扮偣 - 淇璺緞
            const conclusions = data.鍐呭鎻愬彇?.缁撹 || [];
            const innovations = data.鍐呭鎻愬彇?.鍒涙柊鐐?|| [];
            document.getElementById('lit-conclusions').innerHTML = conclusions.length > 0 
                ? conclusions.map(c => `<p class="mb-2">鈥?${escapeHtml(c)}</p>`).join('')
                : '<p class="text-gray-500">鏃犵粨璁轰俊鎭?/p>';
            document.getElementById('lit-innovations').innerHTML = innovations.length > 0 
                ? innovations.map(i => `<p class="mb-2">鈥?${escapeHtml(i)}</p>`).join('')
                : '<p class="text-gray-500">鏃犲垱鏂扮偣淇℃伅</p>';
            
            // 涓嶈冻 - 淇璺緞
            const shortcomings = data.鍐呭鎻愬彇?.涓嶈冻 || [];
            document.getElementById('lit-shortcomings').innerHTML = shortcomings.length > 0 
                ? shortcomings.map(s => `<p class="mb-2">鈥?${escapeHtml(s)}</p>`).join('')
                : '<p class="text-gray-500">鏃犱笉瓒充俊鎭?/p>';
            
            // 鍥捐〃鏁版嵁缂撳瓨锛屽悗缁粨鍚堝浘鐗囧厓鏁版嵁娓叉煋
            currentFigureData = data.鍐呭鎻愬彇?.鍏抽敭鍥捐〃 || [];
            if (Array.isArray(data.image_metadata)) {
                imageMetadata = data.image_metadata;
            }
            renderFiguresList();
        }
        // 娓叉煋鍥捐〃鍒楄〃锛堢粨鍚堝浘鐗囧厓鏁版嵁锛屼粎灞曠ず JSON 涓畾涔夌殑鍥捐〃锛?        function renderFiguresList() {
            const figuresContainer = document.getElementById('lit-figures-list');
            if (!figuresContainer) return;

            const textualFigures = currentFigureData || [];
            if (!textualFigures || textualFigures.length === 0) {
                figuresContainer.innerHTML = '<p class="text-gray-500">鏃犲浘琛ㄤ俊鎭?/p>';
                return;
            }

            figuresContainer.innerHTML = textualFigures.map((figure, index) => renderFigureCard(figure, index)).join('');
        }

        async function refreshCurrentPaperDetail() {
            if (!currentPaperId) return;
            try {
                const response = await fetch(`/api/literature/${currentPaperId}`);
                const literatureData = await response.json();
                if (response.ok) {
                    fillLiteratureDetail(literatureData);
                    if (Array.isArray(literatureData.image_metadata)) {
                        imageMetadata = literatureData.image_metadata;
                        renderFiguresList();
                    } else {
                        await loadImageMetadata(currentPaperId);
                    }
                }
            } catch (error) {
                console.error('鍒锋柊鏂囩尞璇︽儏澶辫触:', error);
            }
        }

        // 鍥剧墖鍏冩暟鎹鐞?        async function loadImageMetadata(paperId) {
            imageMetadata = [];
            renderFiguresList();
            if (!paperId) return;

            try {
                const response = await fetch(`/api/literature/${paperId}/images/metadata`);
                const result = await response.json();
                if (response.ok) {
                    imageMetadata = result.metadata || [];
                    renderFiguresList();
                } else {
                    console.error('鍔犺浇鍥剧墖鍏冩暟鎹け璐?', result.error);
                }
            } catch (error) {
                console.error('鍔犺浇鍥剧墖鍏冩暟鎹け璐?', error);
            }
        }

        function openImageManagerModal() {
            if (!currentPaperId) {
                alert('璇峰厛閫夋嫨鏂囩尞');
                return;
            }
            if (!imageMetadata || imageMetadata.length === 0) {
                alert('褰撳墠鏂囩尞娌℃湁鍙鐞嗙殑鍥剧墖');
                return;
            }
            renderImageManagerForm();
            if (imageMetadataError) {
                imageMetadataError.classList.add('hidden');
                imageMetadataError.textContent = '';
            }
            imageManagerModal?.classList.remove('hidden');
        }

        function hideImageManagerModal() {
            imageManagerModal?.classList.add('hidden');
        }

        function renderImageManagerForm() {
            if (!imageMetadataContainer) return;
            if (!imageMetadata || imageMetadata.length === 0) {
                imageMetadataContainer.innerHTML = '<p class="text-gray-500">鏆傛棤鍥剧墖</p>';
                return;
            }

            const categoryOptions = [
                { value: 'figure', label: '鏅€氬浘' },
                { value: 'subfigure', label: '瀛愬浘 (鍚屼竴鍥惧唴)' },
                { value: 'cover', label: '灏侀潰' },
                { value: 'ignore', label: '蹇界暐' }
            ];

            imageMetadataContainer.innerHTML = imageMetadata.map((item, index) => {
                const imageSrc = `/api/literature/${currentPaperId}/images/${encodeURIComponent(item.filename)}`;
                const optionsHtml = categoryOptions.map(opt => `
                    <option value="${opt.value}" ${item.category === opt.value ? 'selected' : ''}>${opt.label}</option>
                `).join('');

                return `
                <div class="border rounded-lg p-4 flex flex-col md:flex-row gap-4" data-image-row="${index}">
                    <div class="w-full md:w-32 flex-shrink-0">
                        <img src="${imageSrc}" alt="${escapeHtml(item.filename)}" class="w-32 h-32 object-cover rounded-lg border" onerror="this.style.display='none';">
                    </div>
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">鏂囦欢鍚?/label>
                            <p class="text-sm text-gray-700 break-all">${escapeHtml(item.filename)}</p>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">鍥惧彿</label>
                            <input type="text" data-image-field="figure_id" value="${item.figure_id || ''}" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">鏍囩/鎻忚堪</label>
                            <input type="text" data-image-field="label" value="${item.label || ''}" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">绫诲埆</label>
                            <select data-image-field="category" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                ${optionsHtml}
                            </select>
                        </div>
                    </div>
                </div>`;
            }).join('');

            bindMetadataFieldEvents();
        }

        function bindMetadataFieldEvents() {
            if (!imageMetadataContainer) return;
            imageMetadataContainer.querySelectorAll('select[data-image-field="category"]').forEach(select => {
                select.addEventListener('change', handleImageCategoryChange);
                handleImageCategoryChange({ target: select });
            });
        }

        function handleImageCategoryChange(event) {
            const select = event.target;
            const row = select.closest('[data-image-row]');
            if (!row) return;
            const figureInput = row.querySelector('[data-image-field="figure_id"]');
            if (!figureInput) return;
            const disable = ['cover', 'ignore', 'subfigure'].includes(select.value);
            figureInput.disabled = disable;
            figureInput.classList.toggle('bg-gray-100', disable);
            if (disable) {
                if (select.value === 'cover') {
                    figureInput.value = '';
                } else if (select.value === 'ignore') {
                    figureInput.value = '';
                } else if (select.value === 'subfigure') {
                    figureInput.value = '';
                    figureInput.placeholder = '缁ф壙涓婁竴鍥惧彿';
                }
            } else {
                figureInput.placeholder = '';
            }
        }

        function collectImageMetadataFromForm() {
            if (!imageMetadataContainer || !imageMetadata || imageMetadata.length === 0) {
                return [];
            }

            const raw = imageMetadata.map((item, index) => {
                const row = imageMetadataContainer.querySelector(`[data-image-row="${index}"]`);
                if (!row) return { ...item };
                const figureInput = row.querySelector('[data-image-field="figure_id"]');
                const labelInput = row.querySelector('[data-image-field="label"]');
                const categorySelect = row.querySelector('select[data-image-field="category"]');

                return {
                    filename: item.filename,
                    figure_id: figureInput ? figureInput.value.trim() : '',
                    label: labelInput ? labelInput.value.trim() : '',
                    category: categorySelect ? categorySelect.value : 'figure'
                };
            });

            return enforceSequentialFigureIds(raw);
        }

        async function saveImageMetadata() {
            if (!currentPaperId) return;
            const payload = collectImageMetadataFromForm();
            if (imageMetadataError) {
                imageMetadataError.classList.add('hidden');
                imageMetadataError.textContent = '';
            }

            try {
                if (saveImageMetadataBtn) {
                    saveImageMetadataBtn.disabled = true;
                }

                const response = await fetch(`/api/literature/${currentPaperId}/images/metadata`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ metadata: payload })
                });
                const result = await response.json();

                if (response.ok) {
                    imageMetadata = result.metadata || [];
                    renderFiguresList();
                    hideImageManagerModal();
                    await loadLiteratureList();
                    await refreshCurrentPaperDetail();
                    alert('鍥剧墖淇℃伅宸叉洿鏂?);
                } else if (imageMetadataError) {
                    imageMetadataError.textContent = result.error || '淇濆瓨澶辫触';
                    imageMetadataError.classList.remove('hidden');
                }
            } catch (error) {
                console.error('淇濆瓨鍥剧墖鍏冩暟鎹け璐?', error);
                if (imageMetadataError) {
                    imageMetadataError.textContent = '淇濆瓨澶辫触锛岃妫€鏌ョ綉缁滆繛鎺?;
                    imageMetadataError.classList.remove('hidden');
                }
            } finally {
                if (saveImageMetadataBtn) {
                    saveImageMetadataBtn.disabled = false;
                }
            }
        }

        function renderFigureCard(figure, index) {
            const heading = figure.鍥惧簭鍙?|| `鍥?{index + 1}`;
            const description = figure.鏍稿績鍐呭 || '鏃犳弿杩?;
            const typeInfo = figure.鍥捐〃绫诲瀷 || '';
            const supportInfo = figure.鏀拺缁撹 || '';

            const imageSection = buildFigureImages(figure, index);

            return `
                <div class="border rounded-lg p-4">
                    <div class="flex items-start flex-wrap gap-4">
                        ${imageSection}
                        <div class="flex-1 min-w-[220px]">
                            <h4 class="font-semibold text-lg mb-2">${escapeHtml(heading)}</h4>
                            <p class="text-gray-700 leading-relaxed">${escapeHtml(description)}</p>
                            <div class="mt-2 text-sm text-gray-600">
                                <strong>鍥捐〃绫诲瀷:</strong> ${escapeHtml(typeInfo || '鏈煡')}
                            </div>
                            <div class="mt-1 text-sm text-gray-600">
                                <strong>鏀拺缁撹:</strong> ${escapeHtml(supportInfo || '鏆傛棤')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function buildFigureImages(figure, index) {
            const matches = getMetadataMatchesForFigure(figure);
            if (matches.length > 0) {
                const imagesHtml = matches.map(item => {
                    const src = `/api/literature/${currentPaperId}/images/${encodeURIComponent(item.filename)}`;
                    return `
                        <div class="w-32 h-32 rounded-lg overflow-hidden border">
                            <img src="${src}" alt="${escapeHtml(item.label || item.filename)}"
                                 class="w-full h-full object-cover cursor-pointer hover:opacity-80"
                                 onclick="openImageModal('${src}')">
                        </div>
                    `;
                }).join('');

                return `
                    <div class="flex flex-wrap gap-3">
                        ${imagesHtml}
                    </div>
                `;
            }

            // 鍥為€€鍒伴粯璁ゅ懡鍚嶇殑鍥剧墖璧勬簮
            const fallbackId = (figure.鍥惧簭鍙?|| `鍥?{index + 1}`).replace(/[^0-9a-zA-Z]/g, '') || (index + 1).toString();
            const formats = ['png', 'jpeg', 'jpg'];
            const fallbackImages = formats.map((format, formatIndex) => {
                const src = `/api/literature/${currentPaperId}/images/fig${fallbackId}.${format}`;
                const isFirst = formatIndex === 0;
                return `
                    <img src="${src}"
                         alt="${escapeHtml(figure.鍥惧簭鍙?|| `鍥?{index + 1}`)}"
                         class="w-full h-full object-cover cursor-pointer hover:opacity-80 ${!isFirst ? 'hidden' : ''}"
                         onerror="${formatIndex < formats.length - 1 ? `this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden');` : `this.style.display='none'; document.getElementById('no-image-${index}').style.display='flex';`}"
                         onclick="openImageModal('${src}')">
                `;
            }).join('');

            return `
                <div class="flex-shrink-0 w-48 h-32 bg-gray-100 rounded-lg overflow-hidden">
                    ${fallbackImages}
                    <div id="no-image-${index}" class="w-full h-full flex items-center justify-center text-gray-400 hidden">
                        鏃犲浘鐗?                    </div>
                </div>
            `;
        }

        function getMetadataMatchesForFigure(figure) {
            const normalized = normalizeFigureId(figure?.鍥惧簭鍙?;
            if (!normalized) return [];
            return (imageMetadata || []).filter(item => {
                if (!item || !item.figure_id) return false;
                if (item.category === 'cover' || item.category === 'ignore') return false;
                return normalizeFigureId(item.figure_id) === normalized;
            });
        }

        function normalizeFigureId(value) {
            if (!value) return '';
            return value
                .toString()
                .replace(/鍥緗fig|figure|鍥捐〃/gi, '')
                .replace(/[^a-zA-Z0-9]/g, '')
                .toLowerCase();
        }

        function enforceSequentialFigureIds(list) {
            let nextFigureNumber = 1;
            let currentGroupId = '';

            return list.map(item => {
                const normalized = { ...item };
                const category = normalized.category || 'figure';

                if (category === 'cover' || category === 'ignore') {
                    normalized.figure_id = '';
                    currentGroupId = '';
                    return normalized;
                }

                if (category === 'subfigure') {
                    if (!currentGroupId) {
                        currentGroupId = String(nextFigureNumber);
                        nextFigureNumber += 1;
                    }
                    normalized.figure_id = currentGroupId;
                    return normalized;
                }

                normalized.figure_id = String(nextFigureNumber);
                currentGroupId = normalized.figure_id;
                nextFigureNumber += 1;
                return normalized;
            });
        }

        // 鎵撳紑鍥剧墖妯℃€佺獥
        function openImageModal(imageSrc) {
            document.getElementById('imageModalContent').src = imageSrc;
            document.getElementById('imageModal').classList.remove('hidden');
        }

        // 鍒犻櫎鏂囩尞
        async function deleteLiterature(paperId) {
            const confirmed = confirm('纭畾瑕佸垹闄よ繖绡囨枃鐚悧锛?);
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/literature/${paperId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    alert('鏂囩尞宸插垹闄?);
                    await loadLiteratureList();
                    if (currentPaperId === paperId) {
                        currentPaperId = null;
                        document.getElementById('detailView').classList.add('hidden');
                        document.getElementById('listView').classList.remove('hidden');
                    } else {
                        await refreshCurrentPaperDetail();
                    }
                } else {
                    alert('鍒犻櫎澶辫触: ' + (result.error || '鏈煡閿欒'));
                }
            } catch (error) {
                console.error('鍒犻櫎澶辫触:', error);
                alert('鍒犻櫎澶辫触锛岃妫€鏌ョ綉缁滆繛鎺?);
            }
        }

        // 宸ュ叿鍑芥暟锛氳浆涔塇TML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 妯℃€佺獥鍏抽棴鍑芥暟
        function closeModal(modalElement) {
            modalElement.classList.add('hidden');
        }
    </script>
