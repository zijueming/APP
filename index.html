<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FuckPaper - 文献管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0 transition-all duration-300 shadow-xl z-20">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <div class="flex items-center gap-2 font-bold text-xl tracking-tight">
                <span class="text-blue-500">Fuck</span>Paper
            </div>
        </div>

        <nav class="flex-1 py-6 px-3 space-y-1">
            <a href="#" id="nav-home"
                class="flex items-center px-3 py-2.5 rounded-lg text-slate-200 hover:bg-slate-800/60 hover:text-white group transition-all">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                    </path>
                </svg>
                文献库
            </a>
            <a href="#" id="nav-tags"
                class="flex items-center px-3 py-2.5 rounded-lg text-slate-200 hover:bg-slate-800/60 hover:text-white group transition-all">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10M7 12h8m-8 5h6">
                    </path>
                </svg>
                标签管理
            </a>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="bg-slate-800/50 rounded-xl p-4 backdrop-blur-sm border border-slate-700/50">
                <h4 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">统计概览</h4>
                <div class="flex justify-between items-end mb-2">
                    <span class="text-slate-300 text-sm">总文献</span>
                    <span id="stat-total" class="text-xl font-bold text-white">0</span>
                </div>
                <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                    <div class="bg-blue-500 h-full rounded-full" style="width: 70%"></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 relative">
        <!-- Header -->
        <header
            class="h-16 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-6 flex-shrink-0 z-10 sticky top-0">
            <div class="flex items-center flex-1 max-w-2xl">
                <div class="relative w-full max-w-md group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" id="searchInput"
                        class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg leading-5 bg-slate-50 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all sm:text-sm"
                        placeholder="搜索标题、作者、标签...">
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button id="openApiModalBtn"
                    class="p-2 text-slate-400 hover:text-blue-600 transition-colors rounded-full hover:bg-blue-50"
                    title="配置 API">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <div
                    class="h-9 w-9 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold shadow-md cursor-pointer ring-2 ring-white">
                    A
                </div>
            </div>
        </header>

        <!-- View Container -->
        <main class="flex-1 overflow-auto p-6 relative" id="mainContainer">

            <!-- List View -->
            <div id="listView" class="max-w-7xl mx-auto space-y-6 fade-in">
                <!-- Toolbar -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl font-bold text-slate-800 tracking-tight">我的文献</h2>
                        <span class="px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-700 text-xs font-bold"
                            id="paperCountBadge">0</span>
                    </div>
                    <div class="flex items-center gap-3 w-full sm:w-auto">
                        <select id="yearFilter"
                            class="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 shadow-sm hover:border-blue-300 transition-colors cursor-pointer">
                            <option value="">所有年份</option>
                        </select>
                        <select id="tagFilter"
                            class="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 shadow-sm hover:border-blue-300 transition-colors cursor-pointer">
                            <option value="">所有标签</option>
                        </select>
                        <input type="file" id="pdfUploadInput" class="hidden" accept=".pdf">
                        <button id="importButton"
                            class="flex items-center justify-center px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg shadow-sm transition-all hover:shadow-md active:scale-95">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4"></path>
                            </svg>
                            导入文献
                        </button>
                    </div>
                </div>

                <!-- Grid/List -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                    标题</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-48">
                                    作者</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-24">
                                    年份</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-48">
                                    标签</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-40">
                                    上传时间</th>
                                <th scope="col"
                                    class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider w-32">
                                    操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200" id="literatureTableBody">
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-center">
                        <div class="bg-slate-100 p-4 rounded-full mb-4">
                            <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                </path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-slate-900">暂无文献</h3>
                        <p class="text-slate-500 mt-1">点击右上角导入按钮开始添加。</p>
                    </div>
                </div>
            </div>

            <!-- Tag Management View -->
            <div id="tagView" class="hidden max-w-6xl mx-auto space-y-4 fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl font-bold text-slate-800 tracking-tight">标签管理</h2>
                        <span class="px-2.5 py-0.5 rounded-full bg-amber-100 text-amber-700 text-xs font-bold"
                            id="tagCountBadge">0</span>
                    </div>
                    <div class="flex flex-wrap items-center gap-3 w-full sm:w-auto">
                        <div class="relative w-full sm:w-64">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input type="text" id="tagSearchInput"
                                class="w-full pl-9 pr-3 py-2 border border-slate-200 rounded-lg bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 text-sm"
                                placeholder="搜索标签...">
                        </div>
                        <button id="refreshTagsBtn"
                            class="px-4 py-2 bg-white border border-slate-200 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors">
                            刷新
                        </button>
                        <button id="backToLibraryBtn"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg shadow-sm transition-colors">
                            返回文献
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center justify-between px-6 pt-6 pb-4 border-b border-slate-100">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">全局标签列表</p>
                            <p class="text-xs text-slate-500 mt-1">重命名或删除标签会同步到所有文献</p>
                        </div>
                        <p id="tagManageMessage" class="text-sm text-amber-600 hidden"></p>
                    </div>
                    <div class="overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                        标签</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-32">
                                        使用次数</th>
                                    <th
                                        class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider w-40">
                                        操作</th>
                                </tr>
                            </thead>
                            <tbody id="tagTableBody" class="bg-white divide-y divide-slate-200">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                    <div id="tagEmptyState"
                        class="hidden px-6 py-10 text-center text-slate-500 text-sm border-t border-slate-100">
                        暂无标签，先给文献添加一些标签吧。
                    </div>
                </div>
            </div>

            <!-- Detail View -->
            <div id="detailView" class="hidden max-w-7xl mx-auto h-full flex flex-col fade-in">
                <!-- Detail Header -->
                <div class="flex items-start justify-between mb-6">
                    <button id="backToListBtn"
                        class="group flex items-center text-sm text-slate-500 hover:text-blue-600 transition-colors mb-2 px-2 py-1 rounded hover:bg-slate-100">
                        <svg class="w-4 h-4 mr-1 group-hover:-translate-x-1 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        返回列表
                    </button>
                    <div class="flex gap-2">
                        <button id="readPdfBtn"
                            class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 shadow-sm transition-colors flex items-center">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                                </path>
                            </svg>
                            阅读 PDF
                        </button>
                        <button id="editMetadataBtn"
                            class="px-3 py-1.5 bg-white border border-slate-200 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors">
                            编辑信息
                        </button>
                        <button id="manageImagesBtn"
                            class="px-3 py-1.5 bg-white border border-slate-200 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors">
                            管理图片
                        </button>
                        <button id="detailDeleteBtn"
                            class="px-3 py-1.5 bg-white border border-red-200 text-red-600 text-sm font-medium rounded-lg hover:bg-red-50 transition-colors">
                            删除
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full overflow-hidden pb-6">
                    <!-- Left Column: Info & Text -->
                    <div class="lg:col-span-2 flex flex-col gap-6 overflow-y-auto pr-2 pb-10 scrollbar-hide">
                        <!-- Title Card -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
                            <div
                                class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-bl-full -mr-10 -mt-10 opacity-50">
                            </div>
                            <h1 id="lit-title"
                                class="text-2xl font-bold text-slate-900 leading-tight mb-3 relative z-10"></h1>
                            <div class="flex flex-wrap gap-y-2 text-sm text-slate-600 mb-4 relative z-10">
                                <span id="lit-authors" class="font-medium text-slate-800 mr-4"></span>
                                <span class="text-slate-300">|</span>
                                <span id="lit-journal" class="mx-4 italic text-blue-600"></span>
                                <span class="text-slate-300">|</span>
                                <span id="lit-year" class="ml-4 font-mono bg-slate-100 px-2 py-0.5 rounded"></span>
                            </div>
                            <div class="flex flex-wrap gap-2 relative z-10" id="lit-tags-container">
                                <!-- Tags -->
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mt-4">
                                <div class="flex items-center justify-between gap-3">
                                    <div>
                                        <p class="text-sm font-semibold text-slate-900">标签管理</p>
                                        <p class="text-xs text-slate-500">为当前文献添加或移除标签，标签会同步更新列表</p>
                                    </div>
                                    <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-full"
                                        id="detailTagCount">0</span>
                                </div>
                                <div id="detailTagList" class="flex flex-wrap gap-2 mt-3 min-h-[2.25rem]">
                                    <!-- Managed tags -->
                                </div>
                                <div class="mt-4 flex flex-wrap gap-2">
                                    <input id="tagInput" type="text"
                                        class="flex-1 min-w-[180px] px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                        placeholder="新标签...">
                                    <button id="addTagBtn"
                                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-sm transition-colors">添加标签</button>
                                </div>
                                <p id="tagManagerMessage" class="text-xs text-red-500 mt-2 hidden"></p>
                            </div>
                        </div>

                        <!-- Abstract -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="text-lg font-semibold text-slate-900 mb-3 flex items-center">
                                <div
                                    class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center mr-3 text-blue-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 12h16M4 18h7"></path>
                                    </svg>
                                </div>
                                摘要
                            </h3>
                            <p id="lit-abstract" class="text-slate-700 leading-relaxed text-justify"></p>
                        </div>

                        <!-- Conclusions & Innovations -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center mr-3 text-green-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    主要结论
                                </h3>
                                <div id="lit-conclusions" class="text-slate-700 space-y-2"></div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center mr-3 text-purple-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    创新点
                                </h3>
                                <div id="lit-innovations" class="text-slate-700 space-y-2"></div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center mr-3 text-indigo-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3.055 11H5m14 0h1.945M12 5v2m0 10v2m4.95-12.95l-1.414 1.414M8.464 15.536L7.05 16.95m0-9.9l1.414 1.414m8.486 8.486l1.414 1.414">
                                            </path>
                                        </svg>
                                    </div>
                                    实验
                                </h3>
                                <div id="lit-experiments" class="text-slate-700 space-y-2"></div>
                            </div>
                        </div>

                        <!-- Shortcomings -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="text-lg font-semibold text-slate-900 mb-3 flex items-center">
                                <div
                                    class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center mr-3 text-red-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                        </path>
                                    </svg>
                                </div>
                                不足与展望
                            </h3>
                            <div id="lit-shortcomings" class="text-slate-700"></div>
                        </div>
                    </div>

                    <!-- Right Column: Figures -->
                    <div
                        class="lg:col-span-1 bg-slate-100/50 rounded-xl border border-slate-200 flex flex-col overflow-hidden h-full">
                        <div
                            class="p-4 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm z-10">
                            <h3 class="font-semibold text-slate-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-slate-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                    </path>
                                </svg>
                                关键图表
                            </h3>
                            <span class="px-2 py-0.5 bg-slate-100 text-slate-600 text-xs rounded-full font-medium"
                                id="figureCount">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="lit-figures-list">
                            <!-- Figures -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- API Key Modal -->
    <div id="apiModal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center hidden z-50 transition-opacity">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 border border-slate-100">
            <h3 class="text-lg font-bold text-slate-900 mb-4">配置 DeepSeek API</h3>
            <p class="text-sm text-slate-500 mb-4">请输入您的 API 密钥以启用 AI 分析功能。</p>
            <input type="password" id="apiKey"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                placeholder="sk-...">
            <div class="mt-6 flex justify-end gap-3">
                <button id="closeApiModalBtn"
                    class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors font-medium text-sm">取消</button>
                <button id="saveApiKeyBtn"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-sm shadow-sm">保存</button>
            </div>
        </div>
    </div>

    <!-- Metadata Edit Modal -->
    <div id="metadataModal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 border border-slate-100">
            <h3 class="text-lg font-bold text-slate-900 mb-4">编辑文献信息</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">标题</label>
                    <input type="text" id="editMetaTitle"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">作者 (逗号分隔)</label>
                    <input type="text" id="editMetaAuthors"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">年份</label>
                        <input type="text" id="editMetaYear"
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">期刊</label>
                        <input type="text" id="editMetaJournal"
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">上传时间</label>
                    <input type="datetime-local" id="editMetaUploadTime"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">时间标签</label>
                    <input type="datetime-local" id="editMetaTimeLabel"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelMetadataBtn"
                    class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium text-sm">取消</button>
                <button id="saveMetadataBtn"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm shadow-sm">保存</button>
            </div>
        </div>
    </div>

    <!-- Image Modal (Lightbox) -->
    <div id="imageModal"
        class="fixed inset-0 bg-black/95 flex items-center justify-center hidden z-[102] cursor-zoom-out"
        onclick="this.classList.add('hidden')">
        <img id="imageModalContent" src=""
            class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-2xl transition-transform scale-100 cursor-default"
            onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-white/50 hover:text-white"><svg class="w-8 h-8" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg></button>
    </div>

    <!-- Image Manager Modal -->
    <div id="imageManagerModal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center hidden z-[101]">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-6 h-[85vh] flex flex-col border border-slate-100">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-100">
                <div>
                    <h3 class="text-lg font-bold text-slate-900">管理图片标注</h3>
                    <p class="text-xs text-slate-500 mt-1">调整图片顺序、类别及描述信息</p>
                </div>
                <button id="closeImageManagerBtn" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div id="imageMetadataContainer" class="flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-hide">
                <!-- Dynamic Content -->
            </div>
            <div class="mt-4 pt-4 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="document.getElementById('imageManagerModal').classList.add('hidden')"
                    class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium text-sm">取消</button>
                <button id="saveImageMetadataBtn"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm shadow-sm">保存设置</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay"
        class="fixed inset-0 z-50 hidden flex items-center justify-center bg-white/80 backdrop-blur-md">
        <div class="flex flex-col items-center gap-3">
            <div class="h-12 w-12 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
            <p class="text-sm font-medium text-slate-600">加载中...</p>
        </div>
    </div>

    <script>
        // --- Global State ---
        let literatureList = [];
        let currentPaperId = null;
        let apiKey = localStorage.getItem('deepseek_api_key') || '';
        let imageMetadata = [];
        let tagStats = [];

        // --- DOM Elements ---
        const els = {
            listView: document.getElementById('listView'),
            detailView: document.getElementById('detailView'),
            tagView: document.getElementById('tagView'),
            tableBody: document.getElementById('literatureTableBody'),
            emptyState: document.getElementById('emptyState'),
            searchInput: document.getElementById('searchInput'),
            yearFilter: document.getElementById('yearFilter'),
            tagFilter: document.getElementById('tagFilter'),
            statTotal: document.getElementById('stat-total'),
            loading: document.getElementById('loadingOverlay'),
            navHome: document.getElementById('nav-home'),
            navTags: document.getElementById('nav-tags'),
            // Modals
            apiModal: document.getElementById('apiModal'),
            metadataModal: document.getElementById('metadataModal'),
            imageManagerModal: document.getElementById('imageManagerModal'),
            // Detail Fields
            litTitle: document.getElementById('lit-title'),
            litAuthors: document.getElementById('lit-authors'),
            litJournal: document.getElementById('lit-journal'),
            litYear: document.getElementById('lit-year'),
            litAbstract: document.getElementById('lit-abstract'),
            litConclusions: document.getElementById('lit-conclusions'),
            litInnovations: document.getElementById('lit-innovations'),
            litExperiments: document.getElementById('lit-experiments'),
            litShortcomings: document.getElementById('lit-shortcomings'),
            litFiguresList: document.getElementById('lit-figures-list'),
            litTagsContainer: document.getElementById('lit-tags-container'),
            detailTagList: document.getElementById('detailTagList'),
            tagInput: document.getElementById('tagInput'),
            addTagBtn: document.getElementById('addTagBtn'),
            tagManagerMessage: document.getElementById('tagManagerMessage'),
            detailTagCount: document.getElementById('detailTagCount'),
            // Tag Management
            tagTableBody: document.getElementById('tagTableBody'),
            tagCountBadge: document.getElementById('tagCountBadge'),
            tagSearchInput: document.getElementById('tagSearchInput'),
            tagEmptyState: document.getElementById('tagEmptyState'),
            tagManageMessage: document.getElementById('tagManageMessage'),
            refreshTagsBtn: document.getElementById('refreshTagsBtn'),
            backToLibraryBtn: document.getElementById('backToLibraryBtn'),
            // Inputs
            editMetaTitle: document.getElementById('editMetaTitle'),
            editMetaAuthors: document.getElementById('editMetaAuthors'),
            editMetaYear: document.getElementById('editMetaYear'),
            editMetaJournal: document.getElementById('editMetaJournal'),
            editMetaUploadTime: document.getElementById('editMetaUploadTime'),
            editMetaTimeLabel: document.getElementById('editMetaTimeLabel'),
        };

        function renderTagChips(tags, container, options = {}) {
            if (!container) return;
            const { removable = false, emptyMessage = '暂无标签' } = options;
            if (!tags || tags.length === 0) {
                container.innerHTML = `<span class="text-xs text-slate-400 italic">${escapeHtml(emptyMessage)}</span>`;
                return;
            }
            container.innerHTML = tags.map(tag => {
                const safeTag = escapeHtml(tag);
                const encodedTag = encodeURIComponent(tag);
                if (!removable) {
                    return `<span class="text-xs font-medium px-3 py-1 rounded-full bg-slate-100 text-slate-600 border border-transparent">${safeTag}</span>`;
                }
                return `<span class="flex items-center gap-2 pr-2 pl-3 py-1 rounded-full bg-slate-100 text-xs text-slate-600 border border-slate-200">
                    <span class="truncate max-w-[110px]">${safeTag}</span>
                    <button type="button" data-remove-tag="${encodedTag}" class="text-slate-400 hover:text-red-500 leading-none focus:outline-none">×</button>
                </span>`;
            }).join('');
        }

        function createTagManager() {
            const state = { tags: [], busy: false };
            let onChange = () => { };

            function init() {
                if (els.addTagBtn) {
                    els.addTagBtn.addEventListener('click', handleAdd);
                }
                if (els.tagInput) {
                    els.tagInput.addEventListener('keydown', event => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            handleAdd();
                        }
                    });
                }
                if (els.detailTagList) {
                    els.detailTagList.addEventListener('click', event => {
                        const button = event.target.closest('[data-remove-tag]');
                        if (button) {
                            handleRemove(button.dataset.removeTag);
                        }
                    });
                }
                render();
            }

            function render() {
                renderTagChips(state.tags, els.litTagsContainer);
                renderTagChips(state.tags, els.detailTagList, { removable: true, emptyMessage: '尚未添加标签' });
                if (els.detailTagCount) {
                    els.detailTagCount.textContent = `${state.tags.length}`;
                }
            }

            function setTags(tags = []) {
                state.tags = Array.isArray(tags) ? [...tags] : [];
                render();
            }

            function setBusy(value) {
                state.busy = !!value;
                [els.addTagBtn, els.tagInput].forEach(el => {
                    if (el) el.disabled = state.busy;
                });
            }

            function showMessage(text) {
                if (!els.tagManagerMessage) return;
                if (text) {
                    els.tagManagerMessage.textContent = text;
                    els.tagManagerMessage.classList.remove('hidden');
                } else {
                    els.tagManagerMessage.textContent = '';
                    els.tagManagerMessage.classList.add('hidden');
                }
            }

            async function handleAdd() {
                if (state.busy) return;
                if (!currentPaperId) {
                    showMessage('请先选中文献');
                    return;
                }
                const tag = (els.tagInput?.value || '').trim();
                if (!tag) {
                    showMessage('请输入标签名称');
                    return;
                }
                setBusy(true);
                try {
                    const data = await callTagApi('POST', `/api/literature/${currentPaperId}/tags`, { tag });
                    setTags(Array.isArray(data) ? data : []);
                    showMessage('');
                    if (els.tagInput) {
                        els.tagInput.value = '';
                    }
                    onChange();
                } catch (error) {
                    showMessage(error.message || '添加标签失败');
                } finally {
                    setBusy(false);
                }
            }

            async function handleRemove(encodedTag) {
                if (state.busy || !encodedTag) return;
                if (!currentPaperId) {
                    showMessage('请先选中文献');
                    return;
                }
                const decodedTag = decodeURIComponent(encodedTag);
                setBusy(true);
                try {
                    const data = await callTagApi('DELETE', `/api/literature/${currentPaperId}/tags/${encodeURIComponent(decodedTag)}`);
                    setTags(Array.isArray(data) ? data : []);
                    showMessage('');
                    onChange();
                } catch (error) {
                    showMessage(error.message || '移除标签失败');
                } finally {
                    setBusy(false);
                }
            }

            async function callTagApi(method, url, payload) {
                const options = { method };
                if (payload) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(payload);
                }
                const res = await fetch(url, options);
                let data;
                try {
                    data = await res.json();
                } catch {
                    data = null;
                }
                if (!res.ok) {
                    const message = data?.error || '标签操作失败';
                    throw new Error(message);
                }
                return data;
            }

            function setChangeHandler(handler) {
                onChange = typeof handler === 'function' ? handler : () => { };
            }

            return { init, setTags, setChangeHandler };
        }

        const tagManager = createTagManager();

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadLiterature();
            setupEventListeners();
            setActiveNav('home');
        });

        function setupEventListeners() {
            // Navigation
            document.getElementById('backToListBtn').addEventListener('click', showListView);
            if (els.navHome) {
                els.navHome.addEventListener('click', event => {
                    event.preventDefault();
                    showListView();
                });
            }
            if (els.navTags) {
                els.navTags.addEventListener('click', event => {
                    event.preventDefault();
                    showTagView();
                });
            }
            if (els.backToLibraryBtn) {
                els.backToLibraryBtn.addEventListener('click', () => showListView());
            }

            // Upload
            document.getElementById('importButton').addEventListener('click', () => {
                if (!apiKey) return els.apiModal.classList.remove('hidden');
                document.getElementById('pdfUploadInput').click();
            });
            document.getElementById('pdfUploadInput').addEventListener('change', handleUpload);

            // Search & Filter
            els.searchInput.addEventListener('input', renderList);
            els.yearFilter.addEventListener('change', renderList);
            els.tagFilter.addEventListener('change', renderList);

            // API Key
            document.getElementById('openApiModalBtn').addEventListener('click', () => els.apiModal.classList.remove('hidden'));
            document.getElementById('closeApiModalBtn').addEventListener('click', () => els.apiModal.classList.add('hidden'));
            document.getElementById('saveApiKeyBtn').addEventListener('click', saveApiKey);

            // Metadata Edit
            document.getElementById('editMetadataBtn').addEventListener('click', openMetadataModal);
            document.getElementById('cancelMetadataBtn').addEventListener('click', () => els.metadataModal.classList.add('hidden'));
            document.getElementById('saveMetadataBtn').addEventListener('click', saveMetadata);

            // PDF Read
            document.getElementById('readPdfBtn').addEventListener('click', () => {
                if (currentPaperId) window.open(`/api/literature/${currentPaperId}/pdf`, '_blank');
            });

            // Delete
            document.getElementById('detailDeleteBtn').addEventListener('click', deleteCurrentPaper);

            // Image Manager
            document.getElementById('manageImagesBtn').addEventListener('click', openImageManager);
            document.getElementById('closeImageManagerBtn').addEventListener('click', () => els.imageManagerModal.classList.add('hidden'));
            document.getElementById('saveImageMetadataBtn').addEventListener('click', saveImageMetadata);

            // Tag management view
            if (els.refreshTagsBtn) {
                els.refreshTagsBtn.addEventListener('click', loadTagStats);
            }
            if (els.tagSearchInput) {
                els.tagSearchInput.addEventListener('input', renderTagManagement);
            }
            if (els.tagTableBody) {
                els.tagTableBody.addEventListener('click', handleTagTableClick);
            }

            tagManager.init();
        }

        // --- Core Logic ---

        async function loadLiterature() {
            try {
                const res = await fetch('/api/literature');
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                literatureList = data;
                updateFilters();
                renderList();
                updateStats();
            } catch (e) {
                console.error(e);
                // alert('加载失败: ' + e.message);
            }
        }

        async function addTagFromList(paperId) {
            if (!paperId) return;
            const tag = prompt('为该文献添加的新标签', '');
            if (!tag || !tag.trim()) return;
            try {
                const res = await fetch(`/api/literature/${paperId}/tags`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag: tag.trim() })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data?.error || '添加标签失败');
                await loadLiterature();
                if (currentPaperId === paperId) {
                    loadDetail(paperId);
                }
                alert('标签已添加');
            } catch (error) {
                alert(error.message || '添加标签失败');
            }
        }

        tagManager.setChangeHandler(async () => {
            await loadLiterature();
            if (els.tagView && !els.tagView.classList.contains('hidden')) {
                loadTagStats();
            }
        });

        // --- Tag Management View ---

        async function loadTagStats() {
            try {
                const res = await fetch('/api/tags/stats');
                const data = await res.json();
                if (!res.ok) throw new Error(data?.error || '标签列表加载失败');
                tagStats = Array.isArray(data) ? data : [];
                setTagManageMessage('');
                renderTagManagement();
            } catch (error) {
                console.error(error);
                setTagManageMessage(error.message || '加载标签列表失败', true);
                if (els.tagTableBody) {
                    els.tagTableBody.innerHTML = '';
                }
            }
        }

        function renderTagManagement() {
            const query = (els.tagSearchInput?.value || '').toLowerCase();
            const filtered = tagStats.filter(item => (item.tag || '').toLowerCase().includes(query));

            if (els.tagCountBadge) {
                els.tagCountBadge.textContent = `${filtered.length}`;
            }
            if (!els.tagTableBody) return;

            if (filtered.length === 0) {
                els.tagTableBody.innerHTML = '';
                if (els.tagEmptyState) els.tagEmptyState.classList.remove('hidden');
                return;
            }
            if (els.tagEmptyState) els.tagEmptyState.classList.add('hidden');

            els.tagTableBody.innerHTML = filtered.map(item => {
                const safeTag = escapeHtml(item.tag || '');
                const encodedTag = encodeURIComponent(item.tag || '');
                return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-3 text-sm font-semibold text-slate-800">${safeTag}</td>
                    <td class="px-6 py-3 text-sm text-slate-500">${item.count || 0}</td>
                    <td class="px-6 py-3 text-right text-sm font-medium space-x-2">
                        <button data-action="rename-tag" data-tag="${encodedTag}" class="px-3 py-1 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50">重命名</button>
                        <button data-action="delete-tag" data-tag="${encodedTag}" class="px-3 py-1 rounded-lg border border-red-200 text-red-600 hover:bg-red-50">删除</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function handleTagTableClick(event) {
            const button = event.target.closest('[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const tag = decodeURIComponent(button.dataset.tag || '');
            if (!tag) return;

            if (action === 'rename-tag') {
                renameTag(tag);
            } else if (action === 'delete-tag') {
                deleteTag(tag);
            }
        }

        async function renameTag(tag) {
            const newTag = prompt(`将标签 "${tag}" 重命名为`, tag);
            if (!newTag) return;
            const trimmed = newTag.trim();
            if (!trimmed || trimmed === tag) return;

            try {
                const res = await fetch('/api/tags/rename', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_tag: tag, new_tag: trimmed })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data?.error || '重命名失败');
                tagStats = Array.isArray(data) ? data : [];
                setTagManageMessage('标签已重命名');
                renderTagManagement();
                loadLiterature();
            } catch (error) {
                setTagManageMessage(error.message || '重命名失败', true);
            }
        }

        async function deleteTag(tag) {
            const confirmed = confirm(`删除标签 "${tag}" ? 该标签将从所有文献中移除。`);
            if (!confirmed) return;
            try {
                const res = await fetch(`/api/tags/${encodeURIComponent(tag)}`, { method: 'DELETE' });
                const data = await res.json();
                if (!res.ok) throw new Error(data?.error || '删除标签失败');
                tagStats = Array.isArray(data) ? data : [];
                setTagManageMessage('标签已删除');
                renderTagManagement();
                loadLiterature();
            } catch (error) {
                setTagManageMessage(error.message || '删除标签失败', true);
            }
        }

        function setTagManageMessage(text, isError = false) {
            const el = els.tagManageMessage;
            if (!el) return;
            if (text) {
                el.textContent = text;
                el.classList.remove('hidden');
                el.classList.toggle('text-red-600', isError);
                el.classList.toggle('text-amber-600', !isError);
            } else {
                el.textContent = '';
                el.classList.add('hidden');
            }
        }

        function updateFilters() {
            const years = [...new Set(literatureList.map(i => i.year).filter(Boolean))].sort().reverse();
            const tags = [...new Set(literatureList.flatMap(i => i.custom_tags || []))].sort();

            els.yearFilter.innerHTML = '<option value="">所有年份</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
            els.tagFilter.innerHTML = '<option value="">所有标签</option>' + tags.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function renderList() {
            const query = els.searchInput.value.toLowerCase();
            const year = els.yearFilter.value;
            const tag = els.tagFilter.value;

            const filtered = literatureList.filter(item => {
                const matchQuery = (item.title || '').toLowerCase().includes(query) ||
                    (item.authors || []).join(' ').toLowerCase().includes(query);
                const matchYear = !year || item.year == year;
                const matchTag = !tag || (item.custom_tags || []).includes(tag);
                return matchQuery && matchYear && matchTag;
            });

            els.tableBody.innerHTML = filtered.map(item => {
                const uploadTime = item.upload_time ? new Date(item.upload_time).toLocaleString('zh-CN') : '-';
                return `
                <tr class="hover:bg-slate-50 transition-colors cursor-pointer group border-b border-slate-100 last:border-0" onclick="loadDetail('${item.id}')">
                    <td class="px-6 py-4">
                        <div class="text-sm font-semibold text-slate-800 group-hover:text-blue-600 transition-colors line-clamp-2">${escapeHtml(item.title || '无标题')}</div>
                        <div class="text-xs text-slate-500 mt-1 font-medium">${escapeHtml(item.journal || '')}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-500 truncate max-w-xs">${escapeHtml((item.authors || []).join(', '))}</td>
                    <td class="px-6 py-4 text-sm text-slate-500 font-mono">${escapeHtml(item.year || '-')}</td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            ${(item.custom_tags || []).slice(0, 3).map(t => `<span class="px-2 py-0.5 rounded text-xs bg-slate-100 text-slate-600 border border-slate-200">${escapeHtml(t)}</span>`).join('')}
                            ${(item.custom_tags || []).length > 3 ? '<span class="text-xs text-slate-400">...</span>' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-500">${uploadTime}</td>
                    <td class="px-6 py-4 text-right text-sm font-medium">
                        <div class="flex justify-end gap-2">
                            <button class="text-slate-600 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition-opacity px-3 py-1 rounded hover:bg-slate-100 border border-slate-200" onclick="event.stopPropagation(); addTagFromList('${item.id}')">添加标签</button>
                            <button class="text-blue-600 hover:text-blue-800 opacity-0 group-hover:opacity-100 transition-opacity px-3 py-1 rounded hover:bg-blue-50" onclick="event.stopPropagation(); loadDetail('${item.id}')">查看</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            if (filtered.length === 0) {
                els.tableBody.innerHTML = '';
                els.emptyState.classList.remove('hidden');
            } else {
                els.emptyState.classList.add('hidden');
            }

            document.getElementById('paperCountBadge').textContent = filtered.length;
        }

        async function loadDetail(id) {
            els.loading.classList.remove('hidden');
            try {
                const res = await fetch(`/api/literature/${id}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                currentPaperId = id;
                renderDetail(data);
                showDetailView();
            } catch (e) {
                alert('加载详情失败');
            } finally {
                els.loading.classList.add('hidden');
            }
        }

        function renderDetail(data) {
            const info = data.文献信息 || {};
            const content = data.内容提取 || {};

            els.litTitle.textContent = info.标题 || '无标题';
            els.litAuthors.textContent = (info.作者 || []).join(', ');
            els.litJournal.textContent = info.期刊 || '未知期刊';
            els.litYear.textContent = info.年份 || '----';

            els.litAbstract.textContent = content.摘要 || '暂无摘要';

            renderListContent(els.litConclusions, content.结论);
            renderListContent(els.litInnovations, content.创新点);
            renderListContent(els.litExperiments, content.实验 || content.实验结果);
            renderListContent(els.litShortcomings, content.不足);

            // Tags
            const currentTags = data.custom_tags || [];
            tagManager.setTags(currentTags);

            // Figures
            renderFigures(content.关键图表 || [], data.image_metadata || []);
        }

        function renderListContent(container, items) {
            if (!items || items.length === 0) {
                container.innerHTML = '<span class="text-slate-400 italic text-sm pl-4">未提取到相关信息</span>';
                return;
            }
            container.innerHTML = items.map(i => `<p class="mb-2 text-sm leading-relaxed text-slate-700 pl-4 border-l-2 border-slate-100 hover:border-blue-200 transition-colors">• ${escapeHtml(i)}</p>`).join('');
        }

        function renderFigures(textFigures, imgMetadata) {
            const container = els.litFiguresList;
            document.getElementById('figureCount').textContent = `${textFigures.length}`;

            if (textFigures.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-10 flex flex-col items-center"><svg class="w-10 h-10 mb-2 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>无图表信息</div>';
                return;
            }

            container.innerHTML = textFigures.map((fig, idx) => {
                const figId = (fig.图序号 || '').replace(/[^0-9]/g, '');
                const matchedImg = imgMetadata.find(m => (m.figure_id || '').includes(figId) && m.category !== 'ignore');
                const imgSrc = matchedImg ? `/api/literature/${currentPaperId}/images/${matchedImg.filename}` : null;

                return `
                    <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-all group">
                        ${imgSrc ? `<div class="h-40 bg-slate-50 rounded-md mb-3 overflow-hidden flex items-center justify-center cursor-pointer relative" onclick="openImage('${imgSrc}')">
                            <img src="${imgSrc}" class="max-h-full max-w-full object-contain group-hover:scale-105 transition-transform duration-300">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors"></div>
                        </div>` : ''}
                        <h5 class="font-bold text-sm text-slate-800 mb-1 flex justify-between">
                            ${escapeHtml(fig.图序号 || '')}
                            ${!imgSrc ? '<span class="text-xs text-slate-300 font-normal">无图片</span>' : ''}
                        </h5>
                        <p class="text-xs text-slate-600 line-clamp-3 leading-relaxed">${escapeHtml(fig.核心内容 || '')}</p>
                    </div>
                `;
            }).join('');
        }

        // --- Actions ---

        async function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            els.loading.classList.remove('hidden');
            const fd = new FormData();
            fd.append('file', file);

            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}` },
                    body: fd
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                await loadLiterature();
                alert('导入成功');
            } catch (e) {
                alert('导入失败: ' + e.message);
            } finally {
                els.loading.classList.add('hidden');
                e.target.value = '';
            }
        }

        function openMetadataModal() {
            els.editMetaTitle.value = els.litTitle.textContent;
            els.editMetaAuthors.value = els.litAuthors.textContent;
            els.editMetaYear.value = els.litYear.textContent;
            els.editMetaJournal.value = els.litJournal.textContent;
            
            // Load upload_time and time_label from current paper data
            const currentData = literatureList.find(item => item.id === currentPaperId);
            if (currentData && currentData.upload_time) {
                els.editMetaUploadTime.value = convertISOToDatetimeLocal(currentData.upload_time);
            }
            if (currentData && currentData.time_label) {
                els.editMetaTimeLabel.value = convertISOToDatetimeLocal(currentData.time_label);
            } else if (currentData && currentData.upload_time) {
                // Default time_label to upload_time if not set
                els.editMetaTimeLabel.value = convertISOToDatetimeLocal(currentData.upload_time);
            }
            
            els.metadataModal.classList.remove('hidden');
        }

        function convertISOToDatetimeLocal(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (e) {
                return '';
            }
        }

        function convertDatetimeLocalToISO(datetimeLocal) {
            if (!datetimeLocal) return '';
            try {
                const date = new Date(datetimeLocal + ':00');
                return date.toISOString();
            } catch (e) {
                return '';
            }
        }

        async function saveMetadata() {
            const payload = {
                title: els.editMetaTitle.value,
                authors: els.editMetaAuthors.value.split(/[,，]/).map(s => s.trim()).filter(Boolean),
                year: els.editMetaYear.value,
                journal: els.editMetaJournal.value,
                upload_time: convertDatetimeLocalToISO(els.editMetaUploadTime.value),
                time_label: convertDatetimeLocalToISO(els.editMetaTimeLabel.value)
            };

            try {
                const res = await fetch(`/api/literature/${currentPaperId}/metadata`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Failed to update');

                // Refresh
                await loadDetail(currentPaperId);
                await loadLiterature(); // Refresh list too
                els.metadataModal.classList.add('hidden');
            } catch (e) {
                alert('保存失败');
            }
        }

        async function deleteCurrentPaper() {
            if (!confirm('确定要删除这篇文献吗？')) return;
            try {
                await fetch(`/api/literature/${currentPaperId}`, { method: 'DELETE' });
                showListView();
                loadLiterature();
            } catch (e) {
                alert('删除失败');
            }
        }

        // Image Manager Logic
        const imgContainer = document.getElementById('imageMetadataContainer');

        async function openImageManager() {
            if (!currentPaperId) return;
            els.imageManagerModal.classList.remove('hidden');
            imgContainer.innerHTML = '<div class="text-center py-10 text-slate-400">加载中...</div>';

            try {
                const res = await fetch(`/api/literature/${currentPaperId}/images/metadata`);
                const data = await res.json();
                imageMetadata = data.metadata || [];
                renderImageManager();
            } catch (e) {
                imgContainer.innerHTML = '<div class="text-center py-10 text-red-500">加载失败</div>';
            }
        }

        function renderImageManager() {
            if (imageMetadata.length === 0) {
                imgContainer.innerHTML = '<div class="text-center py-10 text-slate-400">暂无图片</div>';
                return;
            }

            imgContainer.innerHTML = imageMetadata.map((img, idx) => `
                <div class="flex gap-4 p-4 border border-slate-200 rounded-xl bg-slate-50 items-start hover:border-blue-200 transition-colors" data-idx="${idx}">
                    <div class="w-24 h-24 flex-shrink-0 bg-white rounded-lg border border-slate-200 overflow-hidden flex items-center justify-center">
                        <img src="/api/literature/${currentPaperId}/images/${img.filename}" class="max-w-full max-h-full object-contain">
                    </div>
                    <div class="flex-1 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">图号</label>
                            <input type="text" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value="${img.figure_id || ''}" onchange="updateImgMeta(${idx}, 'figure_id', this.value)" placeholder="例如: 1">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">类别</label>
                            <select class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all bg-white" onchange="updateImgMeta(${idx}, 'category', this.value)">
                                <option value="figure" ${img.category === 'figure' ? 'selected' : ''}>普通图</option>
                                <option value="subfigure" ${img.category === 'subfigure' ? 'selected' : ''}>子图</option>
                                <option value="cover" ${img.category === 'cover' ? 'selected' : ''}>封面</option>
                                <option value="ignore" ${img.category === 'ignore' ? 'selected' : ''}>忽略</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">描述</label>
                            <input type="text" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value="${img.label || ''}" onchange="updateImgMeta(${idx}, 'label', this.value)" placeholder="图片描述...">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.updateImgMeta = (idx, field, value) => {
            imageMetadata[idx][field] = value;
        };
        window.addTagFromList = addTagFromList;

        async function saveImageMetadata() {
            try {
                await fetch(`/api/literature/${currentPaperId}/images/metadata`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ metadata: imageMetadata })
                });
                alert('图片设置已保存');
                els.imageManagerModal.classList.add('hidden');
                loadDetail(currentPaperId);
            } catch (e) {
                alert('保存失败');
            }
        }

        // --- Helpers ---
        function showListView() {
            els.detailView.classList.add('hidden');
            if (els.tagView) els.tagView.classList.add('hidden');
            els.listView.classList.remove('hidden');
            setActiveNav('home');
        }

        async function showTagView() {
            if (els.listView) els.listView.classList.add('hidden');
            if (els.detailView) els.detailView.classList.add('hidden');
            if (els.tagView) els.tagView.classList.remove('hidden');
            setActiveNav('tags');
            await loadTagStats();
        }

        function showDetailView() {
            els.listView.classList.add('hidden');
            if (els.tagView) els.tagView.classList.add('hidden');
            els.detailView.classList.remove('hidden');
            setActiveNav('home');
        }

        function setActiveNav(target) {
            const active = ['bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-900/20'];
            const inactive = ['text-slate-200', 'hover:bg-slate-800/60', 'hover:text-white'];

            [els.navHome, els.navTags].forEach(nav => {
                if (!nav) return;
                nav.classList.remove(...active);
                inactive.forEach(cls => nav.classList.add(cls));
            });

            const targetEl = target === 'tags' ? els.navTags : els.navHome;
            if (targetEl) {
                targetEl.classList.add(...active);
                inactive.forEach(cls => targetEl.classList.remove(cls));
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKey').value;
            if (key) {
                apiKey = key;
                localStorage.setItem('deepseek_api_key', key);
                els.apiModal.classList.add('hidden');
                alert('API Key 已保存');
            }
        }
        function updateStats() {
            els.statTotal.textContent = literatureList.length;
        }
        function escapeHtml(text) {
            if (!text) return '';
            return text.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        function openImage(src) {
            document.getElementById('imageModalContent').src = src;
            document.getElementById('imageModal').classList.remove('hidden');
        }

    </script>
</body>

</html>